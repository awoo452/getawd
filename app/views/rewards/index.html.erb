<% gaming_levels = [1, 2] %>

<div class="rewards">

  <%# =========================================================
     TODAY'S TASK REWARDS (DAILY, NON-LEVEL-SCOPED)
     ========================================================= %>

    <div class="task-rewards">
      <h3>Today’s Task Rewards</h3>

      <div class="reward-list">
        <% @task_rewards_today.each do |reward| %>
          <div class="reward-row">
            <span>
              <%= reward.reward_payload["item"] %>
              (Level <%= reward.reward_payload["level"] %>)
            </span>

            <%= button_to "Redeem",
                  redeem_task_reward_path(reward),
                  method: :post,
                  class: "btn btn-success btn-sm" %>
          </div>
        <% end %>
      </div>
    </div>

    <hr>

  <%# =========================================================
     LEVEL REWARDS (LEVEL-SCOPED, ONE PER LEVEL)
     ========================================================= %>
  
  <h3>Today’s Level Rewards</h3>

  <% [1, 2, 3].each do |level| %>
    <% earned   = @earned_by_level[level] %>
    <% consumed = @redeemed_levels.include?(level) %>

    <div class="level-header">
      <h3>
        <%= link_to "Level #{level}", doc_path("level-#{level}-rewards") %>
      </h3>
    </div>

    <div class="level-reward <%= earned.present? ? "unlocked" : "locked" %>">

      <div class="reward-gallery">
        <% if gaming_levels.include?(level) %>
          <% @public_games.each do |game| %>
            <img
              src="<%= game_image_url(game) %>"
              alt="<%= game.game_title %>"
            />
          <% end %>
        <% end %>
      </div>

      <%# -------------------------
         Reward overlay / actions
         ------------------------- %>
      <div class="reward-overlay">

        <% if earned.present? && level == 2 %>

          <%= form_with url: redeem_rewards_path(level: 2), method: :post, local: true do %>
            <%= select_tag :game_id,
                  options_from_collection_for_select(
                    Game.where(show_to_public: true),
                    :id,
                    :game_title
                  ),
                  include_blank: "Choose a game" %>

            <br><br>

            <%= submit_tag "Redeem Level 2 Reward", class: "btn btn-success" %>
          <% end %>

        <% elsif earned.present? %>

          <%= button_to "Redeem Reward",
                redeem_rewards_path(level: level),
                method: :post,
                class: "btn btn-success" %>

        <% elsif consumed %>

          <strong>
            All Level <%= level %> rewards claimed. Check back tomorrow.
          </strong>

        <% else %>

          <strong>
            Complete today’s Level <%= level %> tasks to unlock this reward
          </strong>

        <% end %>

      </div>
    </div>

    <hr>
  <% end %>

  <%# =========================================================
     REWARD HISTORY
     ========================================================= %>

  <h3>All Rewards</h3>

  <% earned_rewards    = @rewards.select { |r| r.kind == "earned" } %>
  <% redeemed_rewards  = @rewards.select { |r| r.kind == "redeemed" } %>
  <% completed_rewards = @rewards.select { |r| r.kind == "completed" } %>

  <h3>Earned Rewards</h3>
    <div class="reward-list earned">
      <% earned_rewards.each do |reward| %>
        <div class="reward-row">

          <span>
            <%= link_to reward.name.presence || "Reward ##{reward.id}", reward_path(reward) %>
          </span>

          <% if reward.scope == "task" %>

            <%= button_to "Redeem",
                  redeem_task_reward_path(reward),
                  method: :post,
                  class: "btn btn-success btn-sm" %>

          <% elsif reward.scope == "level" && reward.reward_payload["level"].to_i == 2 && reward.kind == "earned" %>

            <%= form_with url: redeem_rewards_path(level: 2), method: :post, local: true do %>

              <%= hidden_field_tag :reward_id, reward.id %>

              <%= select_tag :game_id,
                    options_from_collection_for_select(
                      @public_games,
                      :id,
                      :game_title
                    ),
                    include_blank: "Choose game" %>

              <%= submit_tag "Redeem", class: "btn btn-success btn-sm" %>

            <% end %>

          <% elsif reward.scope == "level" && reward.kind == "earned" %>

            <%= form_with url: redeem_rewards_path(level: reward.reward_payload["level"]), method: :post, local: true do %>
              <%= hidden_field_tag :reward_id, reward.id %>

              <% if reward.reward_payload["level"].to_i == 2 %>
                <%= select_tag :game_id,
                      options_from_collection_for_select(@public_games, :id, :game_title),
                      include_blank: "Choose game" %>
              <% end %>

              <%= submit_tag "Redeem", class: "btn btn-success btn-sm" %>
            <% end %>

          <% end %>


        </div>
      <% end %>
    </div>


  <h3>Redeemed Rewards</h3>
  <div class="reward-list redeemed">
    <% redeemed_rewards.each do |reward| %>
      <div class="reward-row">
        <%= link_to reward.name.presence || "Reward ##{reward.id}", reward_path(reward) %>
      </div>
    <% end %>
  </div>

  <h3>Completed Rewards</h3>
  <div class="reward-list completed">
    <% completed_rewards.each do |reward| %>
      <div class="reward-row">
        <%= link_to reward.name.presence || "Reward ##{reward.id}", reward_path(reward) %>
      </div>
    <% end %>
  </div>

  <% if @rewards_total_pages.to_i > 1 %>
    <nav class="pagination">
      <% if @rewards_page > 1 %>
        <%= link_to "Prev", rewards_path(page: @rewards_page - 1) %>
      <% end %>
      <span>Page <%= @rewards_page %> of <%= @rewards_total_pages %></span>
      <% if @rewards_page < @rewards_total_pages %>
        <%= link_to "Next", rewards_path(page: @rewards_page + 1) %>
      <% end %>
    </nav>
  <% end %>

</div>
