<%# app/views/rewards/index.html.erb %>

<% gaming_levels = [1, 2] %>

<div class="rewards">

  <% [1, 2, 3].each do |level| %>
    <% earned   = @earned_by_level[level] %>
    <% consumed = @redeemed_levels.include?(level) %>

    <div class="level-1-header">
      <h3>
        <%= link_to "Level #{level}", doc_path("level-#{level}-rewards") %>
      </h3>
    </div>

    <div class="level-1-reward <%= earned.present? ? "unlocked" : "locked" %>">

      <div class="reward-gallery">
        <% if gaming_levels.include?(level) %>
          <% if earned&.reward_payload&.dig("game_id").present? %>
            <% game = Game.find_by(id: earned.reward_payload["game_id"]) %>
            <% if game %>
              <img src="<%= game_cover_url(game) %>" alt="<%= game.game_title %>" />
            <% end %>
          <% else %>
            <% @public_games.each do |game| %>
              <img src="<%= game_cover_url(game) %>" alt="<%= game.game_title %>" />
            <% end %>
          <% end %>
        <% end %>

      </div>

      <div class="reward-overlay">

        <% if earned.present? && level == 2 %>

          <%= form_with url: redeem_rewards_path(level: 2), method: :post do %>
            <%= select_tag :game_id,
                  options_from_collection_for_select(
                    Game.where(show_to_public: true),
                    :id,
                    :game_title
                  ),
                  include_blank: "Choose a game" %>

            <br><br>

            <%= submit_tag "Redeem Level 2 Reward", class: "btn btn-success" %>
          <% end %>

        <% elsif earned.present? %>

          <%= button_to "Redeem Reward",
                redeem_rewards_path(level: level),
                method: :post,
                class: "btn btn-success" %>

        <% elsif consumed %>

          <strong>
            All Level <%= level %> rewards claimed. Check back tomorrow.
          </strong>

        <% else %>

          <strong>
            Complete todayâ€™s Level <%= level %> tasks to unlock this reward
          </strong>

        <% end %>

      </div>
    </div>

    <hr>
  <% end %>

  <h3>All Rewards</h3>
  <div class="reward-list">
    <% @rewards.each do |reward| %>
      <div class="reward-row">
        <%= link_to reward.name.presence || "Reward ##{reward.id}", reward_path(reward) %>
        <small>(<%= reward.kind %>, <%= reward.created_at.to_date %>)</small>
      </div>
    <% end %>
  </div>

</div>
