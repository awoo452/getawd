<% goal_icons = defined?(GOAL_ICONS) ? GOAL_ICONS : {} %>
<section id="task-calendar-daily">
<h1><%= goal_icons["task"] %> | Daily Tasks</h1>
  <%= calendar(number_of_days: 1) do |date| %>
    <% tasks_for_date = @tasks.select { |task| task.due_date.present? && task.due_date.in_time_zone.to_date == date } %>

    <div class="daily-task-levels">
      <% (1..10).each do |level| %>
        <% level_tasks = tasks_for_date.select { |t| t.priority == level } %>
        <% next if level_tasks.empty? %>

        <div class="task-level">
          <h3>
            <%= link_to "Level #{level}", doc_path("level-#{level}-rewards") %>
          </h3>

          <ul>
            <% level_tasks.each do |task| %>
              <li class="task">
                <%= link_to (goal_icons[task.goal&.category] || "ğŸ“"), edit_task_path(task) %>
                <span><%= task.task_name %></span>
                <span class="estimated-time orbitron-text">
                  <% if task.completed? %>
                    <%= goal_icons["task"] %>
                  <% else %>
                    <% percent = if task.actual_time.to_f.zero? || task.estimated_time.to_f.zero?
                                   0
                                 else
                                   ((task.actual_time.to_f / task.estimated_time.to_f) * 100).round
                                 end %>
                    <% bucket = case percent
                               when 0..9 then 0
                               when 10..32 then 25
                               when 33..66 then 50
                               when 67..90 then 75
                               else 100
                               end %>
                    <span class="status-dot progress-<%= bucket %>"></span>
                    <%= task.estimated_time.to_i - task.actual_time.to_i %>m
                  <% end %>
                </span>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>

  <% end %>
</section>
<hr class="calendar-divider">
<section id="task-calendar-monthly">
<h1><%= goal_icons["calendar"] %> | Monthly Calendar</h1>
  <%= month_calendar(attribute: :due_date) do |date| %>
    <ul class="task-calendar-monthly-day">
      <strong class="date_day"><%= date.day %></strong> <!-- Shows the day number -->

      <!-- Fetch tasks for this specific date, adjusted for timezone -->
      <% tasks_for_date = @tasks.select { |task| task.due_date.present? && task.due_date.in_time_zone.to_date == date } %>

      <% tasks_for_date.sort_by { |t| [t.priority.nil? ? -1 : t.priority] }.each do |task| %>
        <li class="task">
          <%= link_to (goal_icons[task.goal&.category] || "ğŸ“"), task_path(task), title: task.task_name %> | 
            <span class="estimated-time orbitron-text">
              <% if task.completed? %>
                <%= goal_icons["task"] %>
              <% else %>
                <% percent = if task.actual_time.to_f.zero? || task.estimated_time.to_f.zero?
                               0
                             else
                               ((task.actual_time.to_f / task.estimated_time.to_f) * 100).round
                             end %>
                <% bucket = case percent
                           when 0..9 then 0
                           when 10..32 then 25
                           when 33..66 then 50
                           when 67..90 then 75
                           else 100
                           end %>
                <span class="status-dot progress-<%= bucket %>"></span>
                <%= task.estimated_time.to_i - task.actual_time.to_i %>m
              <% end %>
            </span>
          </li>
      <% end %>
    </ul>
  <% end %>
</section>
