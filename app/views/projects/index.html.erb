<section class="projects" id="projects">
  <div class="projects-intro">
    <h2 class="page-title">Projects</h2>
    <p class="page-intro">Grouped by service so you can see the scope at a glance.</p>
  </div>
  <% services = @services.to_a %>
  <% service_types = services.map(&:service_type) %>
  <% projects_by_type = @projects.group_by(&:service_type) %>
  <% other_projects = @projects.select { |project| project.service_type.blank? || !service_types.include?(project.service_type) } %>

  <% services.each do |service| %>
    <% service_projects = projects_by_type[service.service_type] || [] %>
    <% next if service_projects.empty? %>
    <% kicker = service.category %>
    <% summary = service.description %>
    <% normalized_kicker = kicker.to_s.strip.downcase %>
    <% normalized_title = service.title.to_s.strip.downcase %>
    <% show_kicker = normalized_kicker.present? && normalized_kicker != normalized_title %>
    <div class="projects-group" id="<%= service.projects_anchor %>">
      <div class="projects-section-header">
        <% if show_kicker %>
          <p class="projects-section-kicker"><%= kicker %></p>
        <% end %>
        <h3 class="projects-section-title"><%= service.title %></h3>
        <% if summary.present? %>
          <p class="projects-section-summary"><%= summary %></p>
        <% end %>
      </div>
      <%= render "project_list", projects: service_projects %>
    </div>
  <% end %>

  <% if other_projects.any? %>
    <% other_summary = "Experiments, legacy builds, and one-off work that doesn't fit a service category." %>
    <% normalized_other_kicker = "" %>
    <% normalized_other_title = "Other Projects".downcase %>
    <% show_other_kicker = normalized_other_kicker.present? && normalized_other_kicker != normalized_other_title %>
    <div class="projects-group" id="other_projects">
      <div class="projects-section-header">
        <% if show_other_kicker %>
          <p class="projects-section-kicker"><%= other_kicker %></p>
        <% end %>
        <h3 class="projects-section-title">Other Projects</h3>
        <% if other_summary.present? %>
          <p class="projects-section-summary"><%= other_summary %></p>
        <% end %>
      </div>
      <%= render "project_list", projects: other_projects %>
    </div>
  <% end %>
  <%= render "shared/pagination",
        page: @projects_page,
        total_pages: @projects_total_pages,
        path_helper: :projects_path %>
</section>
